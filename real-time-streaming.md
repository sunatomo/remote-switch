# 低遅延映像伝送まとめ

当初「youtube liveでいけるっしょ」と高をくくっていたが、いざ試したところ数秒の遅延があり<br>
いろいろ調べ他結果、***[momo](https://github.com/shiguredo/momo)*** に行きつくまでのメモ

## 遅延に関するトレードオフ

### P2P vs サーバ経由

1:1ならP2P一択。多人数配信するときはサーバ経由

企業間でP2PするとNATやファイアウォールではじかれる事もあるので、そういう意味でもサーバ経由がいいらしい。

### TCP vs UDP

画質とるならTCPベース。速度とるならUDPベース

→理論上最低遅延はP2P×UDP

### その他の遅延要素

* FPS
  * FPSを下げればビットレートも下がるので安定性は上がるが、1フレームはバッファされるので時間がかかる。<br>30FPS以下なら人間にはわからないが15FPS位になってくると気になる。
* エンコーディング
  * 最近のPCならハードウェアエンコーディングできるからOK
* 暗号化
  * オーバーヘッドはかかるにせよ、セッション開始後はそんなにコストかかるのか不明
* ネットワーク経路上のさまざまな遅延（割愛）


### UDPベースの技術

#### WebRTC

https://gist.github.com/voluntas/5ef396fe64c06f9563243e034c9eafd7

#### SRT

https://www.explorer-inc.co.jp/srt/basic.html

WebRTCより遅延は数％増えるが、画質は各段に良い。
とくにパケロスしがちな環境で顕著。

使いたかったが、送信・受信プログラムがぱっと出てこなかったので見送り


## 無料系映像伝送

### ストリーミング配信サービス

youtubeやtwichみたいに、一つの映像を多人数でみれるやつ

最速を謳ってるopenrecでも2秒くらい。mixerは専用のプロトコルを使って早かったらしいけどサービス終了したから実力は不明。

**おすすめライブ配信サイトの比較まとめ**
https://w.atwiki.jp/live2ch/pages/534.html

### ビデオチャット

Skype、LineやZoomみたいに少人数でお互いの映像を送れるやつ。
P2Pかと思いきやサーバ経由っぽい。セキュリティの問題らしい。

1秒位

### サーバ経由×UDP

１：１ならayame liteが無料っぽい

1:他はなさそう

### Parsec

https://parsecgaming.com/

独自のプロトコルで通信してるらしいけど、webrtc onブラウザと大差なかった。(実際にカメラで撮って遅延計ってないので感覚です)
<br>映像はwebrtcより奇麗に送れてるように見える（感覚）

ちなみに独自のプロトコルを発揮させるにはホスト、クライアント双方にアプリをインストールする必要がある。

webrtc onブラウザモードもある。

usbカメラの映像を直接送ることはできず、PCの画面全体を送ることしかできない。

### P2P×UDP（本命）

***[momo](https://github.com/shiguredo/momo)***

## momo トラブルシューティング

### Windowsで映像が配信できない

H.264以外(V9,V8)だとできた。現時点のバージョンでは、H.264はNVIDIAのグラボを積んでないと配信できない。

QSV(intel media sdk)に対応すれば Intelプロセッサ搭載機で配信できるらしい。

### Windowsで音が出ない

入力デバイスが複数あると既定のデバイス以外のソースから取得してしまうっぽい。
サウンドの設定から他のソースを無効化すればOK。（スマートなやり方ありそう）

### なんか音がおかしい

いろんなノイズキャンセリングが挟まっているため。 オプションで消せる。

### RaspberryPiで音が出ない

windowsと似た感じ。こちらはpulseaudioをインストールすればOK